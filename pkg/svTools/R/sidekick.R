#' Code sidekickParse
#' 
#' Translate the tree representation generated by 
#' the R parser (parse) into a rectangular representation
#' @export
#' @param file File to parse
#' @return A data frame with the following columns : 
#' - id : Identifier of the current node
#' - srcref1, ..., srcref4 : identifies the position of the current node in the file
#' - description : textual representation of the current node
#' - parent : identifier of the parent node
#' @author Romain Francois \email{francoisromain@@free.fr}
#' @examples
#' tf <- tempfile()
#' cat( "jitter <- " , deparse( jitter ), sep = "\n", file = tf )
#' sidekick( tf )
#' unlink( tf )
sidekick <- function( file ){
	### try to parse and return an error if failed
	p <- try( parse( file ), silent = TRUE )
	if( p %of% "try-error" ){
		return( list( type = "error", data = parseError( p ) ) )
	}
	
	### calls the actual sidekick function
	sidekickParse( p )
}


sidekickParse <- function( p = try( parse(file), silent = TRUE) , top = TRUE, env = new.env(), parent = 0, file ){
	
	if( top ) {
		
		env[["data"]] <- data.frame( 
			id = numeric(0), 
			srcref1 = numeric(0), 
			srcref2 = numeric(0),
			srcref3 = numeric(0),
			srcref4 = numeric(0),
			description = character(0), 
			parent = numeric(0), 
			mode = character(0), stringsAsFactors = FALSE )
		if( p %of% "try-error" ){
			return( env[["data"]] )
		}
		
		maxId <- 0
	} else {
		maxId <- max( env[["data"]][, "id"] ) 
	}
	
	atts <- attributes( p )
	descriptions <-as.character( p )
	hasAttrs <- "srcref" %in% names(atts)
	if( hasAttrs ){
		srcrefs <- t( sapply( attr(p, "srcref"), as.integer ) )  
		colnames( srcrefs ) <- paste("srcref", 1:4 , sep = "")
		srcrefs <- as.data.frame( srcrefs ) 
		ids <- maxId + 1:length(p)
		modes <- sapply( p, mode )
		data <- data.frame( id = ids, 
			srcrefs, description = descriptions, 
			parent = rep( parent, length(p) ), 
			mode = modes, 
			stringsAsFactors = FALSE)
		env[["data"]] <- rbind( env[["data"]], data )
		
	}
	
	calls <- sapply( p, mode ) %in% c("call","function")
  for( i in 1:length(p)){
		if( !is.null(p) && calls[i] ){
			test <- try( looksLikeAFunction( p[[i]] ), silent = TRUE )
			if( test ){
				env[["data"]][ ids[i], "mode" ] <- "function"
				try( sidekickParse( p[[i]], top = FALSE, env = env, parent = if( hasAttrs) ids[i] else parent ), silent = TRUE )  
			} else {
				test <- try( looksLikeAnIf( p[[i]] ), silent = TRUE )
				if( ! test %of% "try-error" && test ){
					pa <- try( addIfNode( TRUE, env = env, parent = if( hasAttrs ) ids[i] else parent, p[[i]][[3]] ), silent = TRUE )
					sidekickParse( p[[i]][[3]], top = FALSE, env = env, parent = pa )
					if( length(p[[i]]) == 4){
						pa <- try( addIfNode( FALSE, env = env, parent = if( hasAttrs ) ids[i] else parent, p[[i]][[4]] ), silent = TRUE )
						sidekickParse( p[[i]][[4]], top = FALSE, env = env, parent = pa )
					}		
				} else{
					sidekickParse( p[[i]], top = FALSE, env = env, parent = if( hasAttrs) ids[i] else parent )
				}
			}
		}
	}
	
	if( top ){
		env[["data"]]
	}
	
}

addIfNode <- function( value = T, env = env, parent, nextnode ){
	
	data <- env[["data"]]
	if( !is.null( srcref <- attr(nextnode, "srcref") ) ){
	  id <- max(data$id) + 1
		lap.out <- lapply( srcref, as.integer )
		srcref <- t(c( 
		  head( lap.out ,1)[[1]][1:2], 
			tail( lap.out ,1)[[1]][3:4] ) ) 
		colnames( srcref ) <- paste( "srcref", 1:4, sep = "") 
	  mode <- paste( "if", value, sep = ":" )
		description <- mode
		env[["data"]] <- rbind( env[["data"]], data.frame( id = id, srcref, description = description, mode = mode, parent = parent ) )
	  id
	} else{
		parent
	}
	 
}

looksLikeAFunction <- function( p ) {
	if( length( p[[1]]) != 1 ) return(FALSE)
	if( ! as.character( p[[1]] ) %in% c("<-", "<<-", "=" ) ) return(FALSE)
	if( length( p ) <= 2 ) return(FALSE) 
	if( is.null( p[[3]] ) ) return(FALSE)
	if( length( p[[3]] ) == 1 ) return(FALSE)
	asc <- as.character( p[[3]][[1]] )
	if( length( asc ) > 1 || asc != "function" ) return(FALSE)
	TRUE
}

looksLikeAnIf <- function(p){
	if( length( p[[1]] ) != 1 ) return(FALSE)
	as.character(p[[1]]) == "if"
}

