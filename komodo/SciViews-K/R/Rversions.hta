
<html>
<head>
<STYLE TYPE="text/css">
.highlight {background:#ff00ff}
.text {color:#ff00ff}
.both {color:white;background:black}
</STYLE> 
</head>
<body>
<h1>Change R Version</h1>
The drop down menu lists all R versions on the current system that
were found.  The current version, if any, is the one
highlighted in purple and initially displayed.
To change the current version, select
the desired one and press Apply.
<form name="RVersionForm">
<select name="dropdown">
<script type="text/jscript">

function MSDOS(DOSCmd, Stream) {
  var alines, sCmd, stemp, ofs, oWS, tempfile;
  sCmd = "%comspec% /c \"" + DOSCmd + "\" " + Stream + "> ";
  ofs = new ActiveXObject("Scripting.FileSystemObject");
  stemp = ofs.GetTempName();
  oWS = new ActiveXObject("Wscript.Shell");
  stemp = oWS.Environment("PROCESS")("TEMP") + "\\" + stemp;
  oWS.Run(sCmd + stemp, 0, true);
  tempFile = ofs.OpenTextFile(stemp)
  alines = tempFile.ReadAll().split(/\r*\n/);
  tempFile.close()
  ofs.DeleteFile(stemp);
  // alines.length = alines.length - 1
  return alines;
}

function SetRVersion(menu) {
	menuo = menu.options[menu.selectedIndex];
	// this worked on XP:
	// WshShell.Run("\"" + menuo.value + "\\bin\\RSetReg.exe\"", 0);
	WshShell.CurrentDirectory = menuo.value;
	// execute at elevated privledge
	// only tested on Vista
	new ActiveXObject("Shell.Application").ShellExecute("bin\\RSetReg.exe", "", "", "runas");
	alert("Current R Version Set to\n" + menuo.value);
	close();
}

// Johan Känngård, http://dev.kanngard.net, wrote uunique() and contains()
function uunique(a) {
	tmp = new Array(0);
	for(i=0;i<a.length;i++){
		if(!contains(tmp, a[i])){
			tmp.length+=1;
			tmp[tmp.length-1]=a[i];
		}
	}
	return tmp;
}
function contains(a, e) {
	for(j=0;j<a.length;j++)if(a[j]==e)return true;
	return false;
}

var fso, WshShell;
var arr, cmd, fc, fields, File, Folder, i, key, parent, regrhome;
var rhome, selected, ver;
WshShell = new ActiveXObject("Wscript.Shell");
fso = new ActiveXObject("Scripting.FileSystemObject");

arr = new Array();

// push main key value
key = "HKLM\\software\\r-core\\r\\InstallPath";
regrhome = WshShell.RegRead(key);
arr.push(regrhome);

// push current directory
arr.push(WshShell.CurrentDirectory);

// push R_HOME
rhome = WshShell.Environment("PROCESS").item("R_HOME")
if (rhome != "") arr.push(rhome)

// push subkeys
key = MSDOS("reg query hklm\\software\\r-core\\r /s", 1);
// alert(key.join(";\n"));
for(i in key) {
   if (key[i].match("InstallPath")) 
      arr.push(key[i].split(/ /).slice(2).join(" "));
}

// sort and remove duplicates
arr.sort();
arr = uunique(arr);

// push those that correspond to R directories
arr2 = new Array();
for(i in arr) {
	arr[i].replace(/\\$/);
	if (fso.FileExists(arr[i] + "\\" + "bin\\Rcmd.exe"))
		arr2.push(arr[i]);
}

// push on sibs that correspond to R directories
n = arr2.length;
for(i = 0; i < n; i++) {
	parent = fso.GetParentFolderName(arr2[i]);
	lastdir = parent.replace(/.*\\/, "");
	if (lastdir == "R") {
		Folder = fso.GetFolder(parent);
		fc = new Enumerator(Folder.SubFolders);
		for (;!fc.atEnd(); fc.moveNext()) {
			File = fc.item();
			WshShell.CurrentDirectory = File.Path;
			if (!contains(arr2, File.Path) &&
				fso.FileExists("bin\\R.exe"))
					arr2.push(File.Path);
		}
	}
}

// entries to arr2 are a single string with three \n-separated fields:
// version, path, selected status
for(i in arr2) {
	selected = "";
	if (arr2[i] == regrhome) {
		selected = "selected=selected class=highlight";
	}
	WshShell.CurrentDirectory = arr2[i];
	cmd = "bin\\R.exe --version";
	ver = MSDOS(cmd, 2)[0];
	arr2[i] = ver + "\n" + arr2[i] + "\n" + selected;
}


arr2.sort().reverse();
for(i in arr2) {
	fields = arr2[i].split("\n");
	document.write("<option " + fields[2] + " value=\"" + fields[1] + "\">" + fields[0] + " - " +  fields[1] + "</option>");
}
</script>
</select>
<input type="button" name="Submit" value="Apply" onClick="javascript:SetRVersion(document.RVersionForm.dropdown)">
<input type="button" name="Cancel" value="Cancel" onClick="javascript:window.close()">
</form>

</body>
</html>
