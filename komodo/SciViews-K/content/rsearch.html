<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>R help: search results</title>

<script type="text/javascript">

function _getWindowByURI(uri) {
	var wm = Components.classes['@mozilla.org/appshell/window-mediator;1']
		.getService(Components.interfaces.nsIWindowMediator);
	en = wm.getEnumerator("");

	if (uri) {
		var win;
		while (en.hasMoreElements()) {
			win = en.getNext();
			if ((win.location.href == uri) ||
				(win.location.href.lastIndexOf(uri) == win.location.href.length - uri.length))
				return win;
		}
	}
	return null;
}



var rHelpXulUri = "chrome://sciviewsk/content/RHelpOverlay.xul";
var rHelpWin, sv;

function askR(topic) {
	if (!topic)	return;

	var cmd = 'svtmp <- help.search("' + topic + '")[];' +
		'cat(svtmp$pattern, "\\n"); ' +
		'if (nrow(svtmp$matches)) {' +
		'svtmp$matches <- cbind(svtmp$matches, Path = apply(matrix(svtmp$matches[, c(1,3)], ncol=2), 1, function(z) c(help(z[1],  package = z[2]))));' +
		'write.table(svtmp$matches, sep=";", row.names = F, col.names = F, quote = F); ' +
		'}; ' +
		'rm(svtmp);';

	sv.r.evalCallback(cmd, displayResults);
}


function displayResults(data) {
		if (!data)
			return;

		var doc = document;
		var out = doc.getElementById("results");

		while (out.childNodes.length) out.removeChild(out.firstChild);


		data = data.split(/[\r\n]+/);
		var p = doc.createElement("p");
		p.appendChild(doc.createTextNode('Search text was: "' + data[0].replace(/(^\s+|\s+$)/g, "") + '"'));
		out.appendChild(p);

		if (data.length == 1) {
			var p = doc.createElement("p");
			p.appendChild(doc.createTextNode("Nothing found."));
			out.appendChild(p);
			return;
		}


		var prevPkg = "", fnList, li, el, p, pkgList;

		pkgList = doc.createElement("div");

		for (var i = 1; i < data.length; i++) {
			var di = data[i].split(/\s*;\s*/);
			var li = doc.createElement("li");

			curPkg = di[2];
			if (curPkg != prevPkg) {
				if (fnList) pkgList.appendChild(fnList);

				p = doc.createElement("p");
				el = doc.createElement("a");
				el.appendChild(doc.createTextNode("Package: " + curPkg));
				el.setAttribute("href", "file://" + di[3] + "/html/00Index.html");
				p.appendChild(el);


				pkgList.appendChild(p);
				fnList = doc.createElement("ol");
			}
			prevPkg = curPkg;
			li = doc.createElement("li");

			el = li.appendChild(doc.createElement("a"));
			el.setAttribute("href", "file://" + di[4]);
			el.appendChild(doc.createTextNode(di[0]));

			li.appendChild(el);
			li.appendChild(doc.createTextNode(" - " + di[1]));
			fnList.appendChild(li);
		}
		pkgList.appendChild(fnList);
		doc.body.appendChild(pkgList);
}


function init() {
	rHelpWin = _getWindowByURI(rHelpXulUri);
	sv = rHelpWin.sv;

	askR(decodeURIComponent(document.location.search.replace(/^\?/, "")));
}


</script>
</head>

<body onload="init();">
<h1>Search results:</h1>
<div id="results"></div>
</body>
</html>
